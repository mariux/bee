#!/bin/bash

pkg="$1 "

runpath=()
needs=()
fname=""
class=""
type=""

destdir=""

declare -A canpath

while read cmd data ; do
    if [ "${cmd:0:1}" = "#" ] ; then
        continue
    fi

    # sort -ur makes R to appear first..
    # so we can collect all rpathes before expanding them
    case "${cmd}" in
        "END")
            for n in "${needs[@]}" ; do
                for p in "${runpath[@]}" ; do
                    echo "${pkg}N ${p}/${n:7} ${n} ${fname}"
                done
                echo "${pkg}N PKGINTERNAL/${n:7} ${n} ${fname}"
                echo "${pkg}N LDDYNPATH/${n:7} ${n} ${fname}"
            done
            ;;

        "START")
            fname="${data}"
            escinfile=${fname//%/%25}
            escinfile=${escinfile// /%20}
            origin="${fname%/*}/"
            runpath=()
            needs=()
            class=""
            type=""
            ;;

        "CLASS")
            class=${data}
            ;;

        "TYPE")
            type=${data}
            if [ "${type}" = "DYN" ] ; then
                echo "${pkg}P ${escinfile} soname:${fname##*/} ${fname}"
                echo "${pkg}P PKGINTERNAL/${escinfile##*/} soname:${fname##*/} ${fname}"
            fi
            ;;

        "R")
            # extract rpath from "rpath:" string..
            rpath="${data:6}"

            # handle ${ORIGIN} in rpath
            rpath="${rpath//\$ORIGIN/${origin}}"

            # save rpath
            runpath+=( "${rpath}" )

            if [ -z "${canpath[$rpath]}" ] ; then
                canpath[$rpath]=$(readlink -f "${destdir}/${rpath}")
            fi

            rrpath=${canpath[$rpath]}

            if [ "$?" = "0" -a -n "${rrpath}" -a "${rpath}" != "${rrpath}" ] ; then
                runpath+=( "${rrpath#${destdir}}" )
            fi
            ;;

        "N")
            needs=( "${needs[@]}" ${data} )
            ;;

        "P")
            if [ "${fname##*/}" != "${data:7}" ] ; then
                echo "${pkg}P ${escinfile%/*}/${data:7} ${data} ${fname}"
            fi
            ;;

        *)
            echo >&2 "Unknown command: '${cmd}': aborting."
            exit 1
            ;;
    esac
done < <(
   while read infile ; do
       echo "START ${infile}"
       readelf -hd "${infile}" 2>/dev/null
       echo "END ${infile}"
   done | grep -E "(^START|^END|Class:|Type:|NEEDED|SONAME|RPATH|RUNPATH)" \
        | sed -e "s,.*(NEEDED).*\[\(.*\)],N soname:\1 ," \
              -e "s,.*(SONAME).*\[\(.*\)],P soname:\1 ," \
              -e "s,.*\(RPATH\|RUNPATH\).*\[\(.*\)],#RPATH :\2 ," \
              -e "/^#RPATH / s,:,\nR rpath:,g;" \
              -e "s,^.*Class:\ \+\([^ ]\+\).*,CLASS \1," \
              -e "s,^.*Type:\ \+\([^ ]\+\).*,TYPE \1," ) \
| sed -e 's,/\+,/,g' \
      -e ':loop s,/[^/]\+/\.\./,/,g; t loop' \
      -e 's,/\./,/,g' \
| sort -u
